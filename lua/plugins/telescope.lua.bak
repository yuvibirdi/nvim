-- lua/plugins/telescope.lua

return {
  "nvim-telescope/telescope.nvim", tag = '0.1.8',
  cmd = "Telescope", -- Lazy-load telescope
  dependencies = {
    "nvim-lua/plenary.nvim",

    -- FIX #1: The FZF Sorter (for typing speed)
    {
      "nvim-telescope/telescope-fzf-native.nvim",
      build = "make",
    },

    -- FIX #2: The Project Manager (now a dependency)
    {
      "DrKJeff16/project.nvim",
      -- We will configure this inside telescope's `extensions` table
    },
  },
  config = function()
    local telescope = require("telescope")

    -- This is the fast `fd` command that respects .gitignore
    local find_command = {
      "fd",
      "--type", "f",
      "--strip-cwd-prefix",
      "--hidden",
      "--no-ignore",   -- This will find files in .gitignore
      "--exclude", ".git", -- But always, always exclude .git
    }

    telescope.setup({
      defaults = {
        -- Tell `find_files` to use our `fd` command
        find_command = find_command,

        -- Tell `live_grep` to use `ripgrep` (rg)
        vimgrep_arguments = {
          "rg",
          "--color=never",
          "--no-heading",
          "--with-filename",
          "--line-number",
          "--column",
          "--smart-case",
          "--hidden",
          "--glob=!.git/",
        },
      },
      extensions = {
        -- This is the config for fzf-native
        fzf = {
          fuzzy = true,
          override_generic_sorter = true,
          override_file_sorter = true,
          case_mode = "smart_case",
        },

        -- This is the config for project.nvim
        projects = {
          -- Your project.nvim config goes here.
          -- e.g., base_dirs = { ".git", "package.json", "Makefile" }
          -- Leaving it empty {} is fine and uses defaults.
        },
      },
    })

    -- IMPORTANT:
    -- We do NOT call `telescope.load_extension()` manually.
    -- By listing them as dependencies and configuring them in the
    -- `extensions` table, `telescope.setup()` loads them automatically.
    require('telescope').load_extension('fzf')
  end,
}
